#!/usr/bin/env bash

if [[ "$npm_command" != "run-script" ]] && [[ "$npm_command" != "run" ]]; then
  echo "This script must be run within npm. Try \`npm build-dev\` or \`make build-dev\` instead."
  exit 1;
fi

VERSION=$(node -p "require('./package.json').version")

echo "Building assets for $ENVIRONMENT with $VERSION ..."

mkdir -p build/assets/$VERSION

cp src/assets/* build/assets 2>/dev/null
cp -r src/assets/css build/assets/$VERSION
cp -r src/assets/img build/assets/$VERSION
cp -r src/assets/js build/assets/$VERSION

sed "s/\${DIST_VERSION}/$VERSION/g" build/assets/info.tpl.json > build/assets/info.json
rm build/assets/info.tpl.json

sed "s/\${DIST_VERSION}/$VERSION/g" config/nj_context.tpl.json > config/nj_context.json

if [[ "$ENVIRONMENT" != "local" ]]; then
  ./bin/compress

  find build/assets/$VERSION -type f -name '*.css' ! -name '*.min.css' -delete
  find build/assets/$VERSION -type f -name '*.js' ! -name '*.min.js' -delete

  rsync -avh build/assets/$VERSION/css/vendors/ build/assets/$VERSION/css
  rsync -avh build/assets/$VERSION/js/vendors/ build/assets/$VERSION/js
  rm -rf build/assets/$VERSION/js/vendors/
  rm -rf build/assets/$VERSION/css/vendors/
fi

echo ""

nunjucks "*.html" config/nj_context.json -p src/templates --options config/nj_options.json -o build/

printf "\nMoving files in to place for paths, including trailing slash ..."

mkdir -p build/planner
mv build/planner_index.html build/planner/index.html
mv build/planner_calendar.html build/planner/calendar.html
mv build/planner_classes.html build/planner/classes.html
mv build/planner_materials.html build/planner/materials.html
mv build/planner_grades.html build/planner/grades.html
cp build/planner/index.html build/calendar.html
cp build/planner/index.html build/planner.html
cp build/planner/index.html build/app.html
cp build/support.html build/contact.html

find "build" -type f -not -path "build/assets/*" -print0 | while IFS= read -r -d $'\0' file; do
    path="${file#build/}"
    path_no_ext="${path%.*}"

    # Filter out error pages (which have all numeric values)
    if [[ "$path_no_ext" =~ ^[0-9]+$ ]]; then
      continue
    fi

    echo "Processing file: $file"

    # Build out files so URIs work with and without trailing slash
    mkdir -p "build/$path_no_ext"
    cp $file "build/$path_no_ext/index.html"
done

# Pull top-level assets up
mv build/assets/favicon.ico build
mv build/assets/favicon.png build
mv build/assets/robots.txt build
mv build/assets/sitemap.xml build
