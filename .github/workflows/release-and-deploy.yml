name: "Release and Deploy"

run-name: "Release and deploy `${{ inputs.bump_type }}` to `${{ inputs.environment }}` (`${{ inputs.platforms }}`)"

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        default: build
        options:
          - build
          - patch
          - minor
          - major
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        default: prod
        options:
          - dev
          - prod
      platforms:
        description: "Platforms to deploy"
        required: true
        type: choice
        default: all
        options:
          - all
          - web
          - android
          - ios

permissions:
  actions: write
  contents: write

jobs:
  release:
    name: Release
    uses: ./.github/workflows/release.yml
    secrets: inherit
    with:
      bump_type: ${{ inputs.bump_type }}

  update-run-name:
    name: Update Run Name
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Update workflow run name
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.release.outputs.version }}
          ENVIRONMENT: ${{ inputs.environment }}
          PLATFORMS: ${{ inputs.platforms }}
        run: |
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs/${{ github.run_id }} \
            -f name="Release and deploy \`$VERSION\` to \`$ENVIRONMENT\` (\`$PLATFORMS\`)"

  deploy:
    name: Deploy
    needs: release
    uses: ./.github/workflows/deploy.yml
    secrets: inherit
    with:
      version_type: specific
      specific_version: ${{ needs.release.outputs.version }}
      artifact_run_id: ${{ github.run_id }}
      environment: ${{ inputs.environment }}
      platforms: ${{ inputs.platforms }}

  summary:
    name: Summary
    needs: [release, deploy]
    if: always() && needs.release.result == 'success' && needs.deploy.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Release and deployment summary
        run: |
          echo "### Release and Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: ${{ inputs.platforms }}" >> $GITHUB_STEP_SUMMARY
