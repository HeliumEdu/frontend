name: "Release and Deploy"

run-name: "Release and deploy `${{ inputs.bump_type }}` to `${{ inputs.environment }}` (`${{ inputs.platforms }}`)"

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        default: build
        options:
          - build
          - patch
          - minor
          - major
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        default: prod
        options:
          - dev
          - prod
      platforms:
        description: "Platforms to deploy"
        required: true
        type: choice
        default: all
        options:
          - all
          - web
          - android
          - ios

jobs:
  release:
    name: Release
    uses: ./.github/workflows/release.yml
    secrets: inherit
    with:
      bump_type: ${{ inputs.bump_type }}

  deploy:
    name: Trigger Deploy
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deploy workflow
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          VERSION: ${{ needs.release.outputs.version }}
          ENVIRONMENT: ${{ inputs.environment }}
          PLATFORMS: ${{ inputs.platforms }}
        run: |
          gh workflow run deploy.yml \
            --repo ${{ github.repository }} \
            -f version_type=specific \
            -f specific_version="$VERSION" \
            -f environment="$ENVIRONMENT" \
            -f platforms="$PLATFORMS"

          echo "### Deploy Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: $PLATFORMS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A separate deploy workflow has been triggered. Check the [Actions tab](https://github.com/${{ github.repository }}/actions/workflows/deploy.yml) for progress." >> $GITHUB_STEP_SUMMARY
