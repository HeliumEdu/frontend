name: "Export Secrets (One-Time)"

run-name: "Export Secrets"

on:
  workflow_dispatch:
    inputs:
      export_passphrase:
        description: "Passphrase used to encrypt the exported secrets artifact"
        required: true
        type: string

permissions:
  contents: read
  actions: write

jobs:
  export-secrets:
    name: Export Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Write secrets to file
        env:
          ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          ANDROID_SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
          ANDROID_SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          IOS_BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          umask 077
          {
            printf 'ANDROID_SIGNING_KEY_ALIAS=%s\n' "$ANDROID_SIGNING_KEY_ALIAS"
            printf 'ANDROID_SIGNING_KEY_PASSWORD=%s\n' "$ANDROID_SIGNING_KEY_PASSWORD"
            printf 'ANDROID_SIGNING_STORE_PASSWORD=%s\n' "$ANDROID_SIGNING_STORE_PASSWORD"
            printf 'ANDROID_KEYSTORE_BASE64=%s\n' "$ANDROID_KEYSTORE_BASE64"
            printf 'IOS_BUILD_CERTIFICATE_BASE64=%s\n' "$IOS_BUILD_CERTIFICATE_BASE64"
            printf 'IOS_P12_PASSWORD=%s\n' "$IOS_P12_PASSWORD"
            printf 'IOS_KEYCHAIN_PASSWORD=%s\n' "$IOS_KEYCHAIN_PASSWORD"
            printf 'IOS_PROVISIONING_PROFILE_BASE64=%s\n' "$IOS_PROVISIONING_PROFILE_BASE64"
          } > secrets.env

      - name: Encrypt export
        env:
          EXPORT_PASSPHRASE: ${{ github.event.inputs.export_passphrase }}
        run: |
          openssl enc -aes-256-cbc -salt -pbkdf2 \
            -in secrets.env \
            -out secrets.env.enc \
            -pass env:EXPORT_PASSPHRASE
          rm -f secrets.env

      - name: Upload encrypted artifact
        uses: actions/upload-artifact@v4
        with:
          name: secrets-export
          path: secrets.env.enc
          retention-days: 7
