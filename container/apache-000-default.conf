<VirtualHost *:3000>
    DocumentRoot /app

    ErrorLog /dev/stderr
    CustomLog /dev/stdout combined

    # Serve static application
    <Directory "/app">
      Require all granted

      RewriteEngine On
      RewriteBase /

      # Prepend www
      RewriteCond %{HTTP_HOST} !^localhost [NC]
      RewriteCond %{HTTP_HOST} !^www\. [NC]
      # Don't cause redirect for /health checks
      RewriteCond %{REQUEST_URI} !^/health(\/)?(\.json)?
      RewriteRule ^(.*)$ http://www.%{HTTP_HOST}/$1 [L,R=301,L,NC]

      # Drop trailing /, except for /planner
      RewriteCond %{REQUEST_URI} !^/planner/$
      RewriteRule ^(.*)/+$ $1 [R=301,L]

      # If URI does not include an extension, map it to a corresponding HTML or JSON file (if exists)
      RewriteCond %{REQUEST_FILENAME}.html -f
      RewriteCond %{REQUEST_FILENAME} !-d
      RewriteRule (.*) $1.html [L]
      RewriteCond %{REQUEST_FILENAME}.json -f
      RewriteCond %{REQUEST_FILENAME} !-d
      RewriteRule (.*) $1.json [L]

      # Rewrite assets that should also live at root
      RewriteRule ^favicon\.ico$ /assets/favicon.ico [L]
      RewriteRule ^favicon\.png$ /assets/favicon.png [L]
      RewriteRule ^health(\/)?(\.json)?$ /assets/health.json [L]
      RewriteRule ^robots\.txt$ /assets/robots.txt [L]
      RewriteRule ^sitemap\.txt$ /assets/sitemap.txt [L]

      ErrorDocument 404 /404.html
      ErrorDocument 500 /500.html
      ErrorDocument 503 /503.html
    </Directory>
</VirtualHost>
